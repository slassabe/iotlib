<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Guide &mdash; iotlib 2.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=51b770b3"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="iotlib" href="modules.html" />
    <link rel="prev" title="Core Concepts" href="concepts.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            iotlib
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Core Concepts</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">User Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#mqtt-connection">MQTT connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#device-discovery">Device discovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monitoring-device-availability">Monitoring Device Availability</a></li>
<li class="toctree-l2"><a class="reference internal" href="#switch-state-logging">Switch state Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#switch-management">Switch Management</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">iotlib</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">iotlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">User Guide</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/userguide.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="user-guide">
<h1>User Guide<a class="headerlink" href="#user-guide" title="Link to this heading"></a></h1>
<section id="mqtt-connection">
<h2>MQTT connection<a class="headerlink" href="#mqtt-connection" title="Link to this heading"></a></h2>
<p>In this example, we establish a connection to the local MQTT broker, initiate the process, wait for 2 seconds, and then stop the process. This brief pause allows for any pending operations to complete before the connection is closed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">iotlib</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="device-discovery">
<h2>Device discovery<a class="headerlink" href="#device-discovery" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">iotlib.discoverer</span></code> module provides discoverers that can be instantiated to find and identify connected IoT devices in your network. These discoverers use various protocols and techniques to detect a wide range of devices, providing a comprehensive overview of the IoT landscape within your network.</p>
<p>In this basic example, we utilize the <code class="docutils literal notranslate"><span class="pre">get_devices()</span></code> method from the <code class="docutils literal notranslate"><span class="pre">UnifiedDiscoverer</span></code> class. This method is used to retrieve all connected devices after a specified waiting period. It provides a simple and efficient way to discover and interact with all available devices in your network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">iotlib</span>

<span class="k">def</span> <span class="nf">basic_discovery</span><span class="p">(</span><span class="n">mqtt_client</span><span class="p">:</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">):</span>
    <span class="n">_discoverer</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">discoverer</span><span class="o">.</span><span class="n">UnifiedDiscoverer</span><span class="p">(</span><span class="n">mqtt_client</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">_discoverer</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Basic discovery - length : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - device: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Create MQTT client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">basic_discovery</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This example will output :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Basic<span class="w"> </span>discovery<span class="w"> </span>-<span class="w"> </span>length<span class="w"> </span>:<span class="w"> </span><span class="m">14</span>
<span class="w"> </span>-<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>SWITCH_CAVE,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>0x00124b0025e23b21,<span class="w"> </span>model:<span class="w"> </span>Model.ZB_MINI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.Z2M&gt;
<span class="w"> </span>-<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>SWITCH_CHAUFFERIE,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>0x00124b00257b862a,<span class="w"> </span>model:<span class="w"> </span>Model.ZB_MINI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.Z2M&gt;
<span class="w">  </span>...
<span class="w"> </span>-<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>tasmota_577591,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>tasmota-577591-5521,<span class="w"> </span>model:<span class="w"> </span>Model.SHELLY_PLUGS,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.TASMOTA&gt;
<span class="w"> </span>-<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>tasmota_D6590C,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>tasmota-D6590C-6412,<span class="w"> </span>model:<span class="w"> </span>Model.SHELLY_UNI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.TASMOTA&gt;
</pre></div>
</div>
<p>However, keep in mind that the list of devices can change over time. To handle this, a <code class="docutils literal notranslate"><span class="pre">DiscoveryProcessor</span></code> is available,
which allows you to customize the behavior when new devices are discovered. Each time a device is found, the <code class="docutils literal notranslate"><span class="pre">process_discovery_update(self,</span> <span class="pre">devices)</span></code>
method is called with the updated list of devices. This provides a flexible way to handle changes in the device landscape.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">iotlib</span>

<span class="k">class</span> <span class="nc">BasicDiscoveryProc</span><span class="p">(</span><span class="n">iotlib</span><span class="o">.</span><span class="n">discoverer</span><span class="o">.</span><span class="n">DiscoveryProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_discovery_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devices</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discovered </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">devices</span><span class="p">)</span><span class="w"> </span><span class="si">:}</span><span class="s2"> devices&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; * device: </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">discover_it</span><span class="p">(</span><span class="n">mqtt_client</span><span class="p">:</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">):</span>
    <span class="n">_discoverer</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">discoverer</span><span class="o">.</span><span class="n">UnifiedDiscoverer</span><span class="p">(</span><span class="n">mqtt_client</span><span class="p">)</span>
    <span class="n">_discoverer</span><span class="o">.</span><span class="n">add_discovery_processor</span><span class="p">(</span><span class="n">BasicDiscoveryProc</span><span class="p">())</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>This example will output :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Discovered<span class="w"> </span><span class="m">10</span><span class="w"> </span>devices
<span class="w"> </span>*<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>SWITCH_CAVE,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>0x00124b0025e23b21,<span class="w"> </span>model:<span class="w"> </span>Model.ZB_MINI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.Z2M&gt;
<span class="w"> </span>*<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>SWITCH_CHAUFFERIE,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>0x00124b00257b862a,<span class="w"> </span>model:<span class="w"> </span>Model.ZB_MINI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.Z2M&gt;
<span class="w">  </span>...
Discovered<span class="w"> </span><span class="m">1</span><span class="w"> </span>devices
<span class="w"> </span>*<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>tasmota_577591,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>tasmota-577591-5521,<span class="w"> </span>model:<span class="w"> </span>Model.SHELLY_PLUGS,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.TASMOTA&gt;
Discovered<span class="w"> </span><span class="m">1</span><span class="w"> </span>devices
<span class="w"> </span>*<span class="w"> </span>device:<span class="w"> </span>&lt;Device<span class="w"> </span>:<span class="w"> </span>tasmota_D6590C,<span class="w"> </span>address<span class="w"> </span>:<span class="w"> </span>tasmota-D6590C-6412,<span class="w"> </span>model:<span class="w"> </span>Model.SHELLY_UNI,<span class="w"> </span>protocol:<span class="w"> </span>Protocol.TASMOTA&gt;
<span class="w">  </span>...
</pre></div>
</div>
<p>Please note that the <code class="docutils literal notranslate"><span class="pre">process_discovery_update</span></code> method is executed sequentially, first for devices supported by Zigbee2MQTT, and then for devices supported by Tasmota. This sequence occurs over a period of time, allowing for a systematic update of all connected devices.</p>
</section>
<section id="monitoring-device-availability">
<h2>Monitoring Device Availability<a class="headerlink" href="#monitoring-device-availability" title="Link to this heading"></a></h2>
<p>This section demonstrates how to utilize the <code class="docutils literal notranslate"><span class="pre">MQTTBridge</span></code> and <code class="docutils literal notranslate"><span class="pre">AvailabilityProcessor</span></code> to monitor and log the availability of a device. Instead of employing an active loop, we will configure the behavior based on the device state using processors.</p>
<ol class="arabic simple">
<li><p><strong>Create a Codec for Airsensor</strong>: This step involves setting up a codec for a Sonoff model device that is connected via the default Zigbee protocol.</p></li>
<li><p><strong>Instantiate a Bridge</strong>: Here, we create an instance of MQTTBridge. This serves as the communication facilitator between the virtual sensor and the MQTT broker.</p></li>
<li><p><strong>Set up an Availability Logger</strong>: This logger is responsible for tracking the device’s availability.</p></li>
<li><p><strong>Register the Availability Logger with the Bridge</strong>: This step involves adding the previously created logger to the bridge.</p></li>
<li><p><strong>Initiate the MQTT Client</strong>: This will establish a connection with the broker and start listening for messages.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">iotlib</span>


<span class="n">DEVICE_NAME</span> <span class="o">=</span> <span class="s1">&#39;TEMP_SALON&#39;</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="c1"># 1) Create a codec for the device model and protocol</span>
<span class="n">codec</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">CodecFactory</span><span class="p">()</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">ZB_AIRSENSOR</span><span class="p">,</span>
                                                      <span class="n">protocol</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
                                                      <span class="n">device_name</span><span class="o">=</span><span class="n">DEVICE_NAME</span><span class="p">)</span>
<span class="c1"># 2) Create a bridge instance to connect the codec to the MQTT client</span>
<span class="n">bridge</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">MQTTBridge</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">codec</span><span class="p">)</span>
<span class="c1"># 3) Create an availability logger, which logs the availability of the device</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">AvailabilityLogger</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># 4) Add the availability logger to the bridge</span>
<span class="n">bridge</span><span class="o">.</span><span class="n">add_availability_processor</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<span class="c1"># 5) Start the MQTT client, which will connect to the broker and start</span>
<span class="c1"># listening for messages</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># 6) Start an infinite loop to handle messages</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Should display ;</span>
<span class="c1">#  - if the device is configured and available : [INFO] [TEMP_SALON] is available</span>
<span class="c1">#  - if the device is configured and unavailable : [INFO] [TEMP_SALON] is unavailable</span>
<span class="c1">#  Nothing is displayed if the device is not not configured in Zigbee2MQTT</span>

</pre></div>
</div>
<p>The output will display one of the following messages:</p>
<ul class="simple">
<li><p>If the device is configured and available, it will display: “[INFO] [TEMP_SALON] is available”.</p></li>
<li><p>If the device is configured but unavailable, it will display: “[INFO] [TEMP_SALON] is unavailable”.</p></li>
<li><p>If the device is not configured in Zigbee2MQTT, there will be no output.</p></li>
</ul>
</section>
<section id="switch-state-logging">
<h2>Switch state Logging<a class="headerlink" href="#switch-state-logging" title="Link to this heading"></a></h2>
<p>This example demonstrates how to create a Sonoff ZBMINI switch and log its values via the Zigbee2MQTT gateway. The steps include creating a virtual switch, a codec instance, a bridge instance, and a logger instance, setting the virtual switch to ON, and starting the main loop.</p>
<ol class="arabic simple">
<li><p><strong>Create a Virtual Switch</strong>: This switch is configured with a 2-second countdown, meaning it will automatically turn off 2 seconds after being turned on.</p></li>
<li><p><strong>Create a Codec Instance</strong>: The CodecFactory is used to create a codec instance associated with the virtual switch. This codec is configured for the device named <code class="docutils literal notranslate"><span class="pre">SWITCH_CAVE</span></code>, the ZB_MINI model and the Z2M protocol.</p></li>
<li><p><strong>Create a Bridge Instance</strong>: The MQTTBridge is used to facilitate communication between the virtual switch and the MQTT broker.</p></li>
<li><p><strong>Create a Logger Instance</strong>: A logger is created to log updates from the virtual switch. This is useful for debugging and record-keeping.</p></li>
<li><p><strong>Set the Virtual Switch to ON</strong>: The virtual switch is manually triggered to start in the ON state.</p></li>
<li><p><strong>Start the Main Loop</strong>: The main loop is started, which keeps the program running indefinitely.</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">iotlib</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># 1) Create a virtual switch </span>
<span class="n">v_switch</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">virtualdev</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">friendly_name</span><span class="o">=</span><span class="s1">&#39;switch&#39;</span><span class="p">,</span>
                                    <span class="n">quiet_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># debouncing mode</span>
                                    <span class="n">countdown</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> 
<span class="c1"># 2) Create a codec instance </span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">CodecFactory</span><span class="p">()</span>
<span class="n">codec</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">ZB_MINI</span><span class="p">,</span>
                                <span class="n">protocol</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
                                <span class="n">device_name</span><span class="o">=</span><span class="s1">&#39;SWITCH_CAVE&#39;</span><span class="p">,</span>
                                <span class="n">v_switch</span><span class="o">=</span><span class="n">v_switch</span><span class="p">)</span>
<span class="c1"># 3) Create a bridge instance </span>
<span class="n">iotlib</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">MQTTBridge</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">codec</span><span class="p">)</span>
<span class="c1"># 4) Create a logger instance </span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">VirtualDeviceLogger</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
<span class="n">v_switch</span><span class="o">.</span><span class="n">processor_append</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<span class="c1"># 5) Set the virtual switch to ON</span>
<span class="n">v_switch</span><span class="o">.</span><span class="n">trigger_start</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>  
<span class="c1"># 6) Start the main loop</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the Zigbee switch is set to ON, it will automatically turn OFF after 2 seconds. The log output will show the power state changes of the virtual switch:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-<span class="w"> </span>Logging<span class="w"> </span>virtual<span class="w"> </span>device<span class="w"> </span><span class="o">(</span>friendly_name<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;switch&quot;</span><span class="w"> </span>-<span class="w"> </span>property<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;power&quot;</span><span class="w"> </span>-<span class="w"> </span>value<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;True&quot;</span><span class="o">)</span>
-<span class="w"> </span>Logging<span class="w"> </span>virtual<span class="w"> </span>device<span class="w"> </span><span class="o">(</span>friendly_name<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;switch&quot;</span><span class="w"> </span>-<span class="w"> </span>property<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;power&quot;</span><span class="w"> </span>-<span class="w"> </span>value<span class="w"> </span>:<span class="w"> </span><span class="s2">&quot;False&quot;</span><span class="o">)</span>
</pre></div>
</div>
</section>
<section id="switch-management">
<h2>Switch Management<a class="headerlink" href="#switch-management" title="Link to this heading"></a></h2>
<p>This example extends the previous one by controlling a Switch with two sensors: a button and a motion sensor.</p>
<p>The steps are as follows:</p>
<ul class="simple">
<li><p>Steps 1 to 3 are the same as in the previous example.</p></li>
<li><p>Step 4: Set up a motion sensor with <code class="docutils literal notranslate"><span class="pre">MotionTrigger</span></code> processing support. This action will turn the light ON when motion is detected.</p>
<ul>
<li><p>4.1: <strong>Instantiate a virtual motion sensor</strong>, create a codec instance, and establish a bridge instance for the virtual motion sensor.</p></li>
<li><p>4.2: <strong>Generate a processor instance</strong> for the virtual motion sensor that can detect motion.</p></li>
<li><p>4.3: <strong>Add the switch</strong> to the list of observers for the virtual motion sensor.</p></li>
</ul>
</li>
<li><p>Step 5: Establish a button sensor with <code class="docutils literal notranslate"><span class="pre">ButtonTrigger</span></code> processing support. This action will turn the light ON when the button is pressed.</p>
<ul>
<li><p>5.1: <strong>Instantiate a virtual button sensor</strong>, create a codec instance, and establish a bridge instance for the virtual button sensor.</p></li>
<li><p>5.2: <strong>Generate a processor instance</strong> for the virtual button sensor that can detect a key press.</p></li>
<li><p>5.3: <strong>Add the switch</strong> to the list of observers for the virtual button sensor.</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">iotlib</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">MQTTClient</span><span class="p">(</span><span class="s1">&#39;switch_mgr&#39;</span><span class="p">,</span> <span class="s1">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="c1"># 1) Create a virtual switch </span>
<span class="n">v_switch</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">virtualdev</span><span class="o">.</span><span class="n">Switch</span><span class="p">(</span><span class="n">quiet_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>    <span class="c1"># debouncing mode</span>
                                    <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="c1"># 2) Create a codec instance </span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">CodecFactory</span><span class="p">()</span>
<span class="n">switch_codec</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">ZB_MINI</span><span class="p">,</span>
                                       <span class="n">protocol</span><span class="o">=</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
                                       <span class="n">device_name</span><span class="o">=</span><span class="s1">&#39;SWITCH_PLUG&#39;</span><span class="p">,</span>
                                       <span class="n">v_switch</span><span class="o">=</span><span class="n">v_switch</span><span class="p">)</span>
<span class="c1"># 3) Create a bridge instance </span>
<span class="n">iotlib</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">MQTTBridge</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">switch_codec</span><span class="p">)</span>
<span class="c1"># 4.1) Instantiate a virtual motion sensor</span>
<span class="n">v_motion</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">virtualdev</span><span class="o">.</span><span class="n">Motion</span><span class="p">()</span>
<span class="n">motion_codec</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">ZB_MOTION</span><span class="p">,</span>
                                       <span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
                                       <span class="n">device_name</span><span class="o">=</span><span class="s1">&#39;MOTION_CAVE&#39;</span><span class="p">,</span>
                                       <span class="n">v_motion</span><span class="o">=</span><span class="n">v_motion</span><span class="p">)</span>
<span class="n">iotlib</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">MQTTBridge</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">motion_codec</span><span class="p">)</span>
<span class="c1"># 4.2) Generate a processor instance</span>
<span class="n">v_motion</span><span class="o">.</span><span class="n">processor_append</span><span class="p">(</span><span class="n">iotlib</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">MotionTrigger</span><span class="p">(</span><span class="n">mqtt_service</span><span class="o">=</span><span class="n">client</span><span class="p">))</span>
<span class="c1"># 4.3) Add the switch </span>
<span class="n">v_motion</span><span class="o">.</span><span class="n">add_observer</span><span class="p">(</span><span class="n">v_switch</span><span class="p">)</span>

<span class="c1"># 5.1) Instantiate a virtual button sensor</span>
<span class="n">v_button</span> <span class="o">=</span> <span class="n">iotlib</span><span class="o">.</span><span class="n">virtualdev</span><span class="o">.</span><span class="n">Button</span><span class="p">()</span>
<span class="n">button_codec</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">create_instance</span><span class="p">(</span><span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">ZB_BUTTON</span><span class="p">,</span>
                                       <span class="n">iotlib</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">Protocol</span><span class="o">.</span><span class="n">Z2M</span><span class="p">,</span>
                                       <span class="n">device_name</span><span class="o">=</span><span class="s1">&#39;INTER_CAVE&#39;</span><span class="p">,</span>
                                       <span class="n">v_button</span><span class="o">=</span><span class="n">v_button</span><span class="p">)</span>
<span class="n">iotlib</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">MQTTBridge</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">button_codec</span><span class="p">)</span>
<span class="c1"># 5.2) Generate a processor instance </span>
<span class="n">v_button</span><span class="o">.</span><span class="n">processor_append</span><span class="p">(</span><span class="n">iotlib</span><span class="o">.</span><span class="n">processor</span><span class="o">.</span><span class="n">ButtonTrigger</span><span class="p">(</span><span class="n">mqtt_service</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
                                                         <span class="n">countdown_long</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># 5.3) Add the switch</span>
<span class="n">v_button</span><span class="o">.</span><span class="n">add_observer</span><span class="p">(</span><span class="n">v_switch</span><span class="p">)</span>

<span class="c1"># 6) Start the main loop</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="concepts.html" class="btn btn-neutral float-left" title="Core Concepts" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="modules.html" class="btn btn-neutral float-right" title="iotlib" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Serge LASSABE.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>